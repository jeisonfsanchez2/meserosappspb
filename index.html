<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bar Sanchez - Service Link</title>
    
    <!-- 1. Estilos: Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React y ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 3. Babel para traducir el código -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Librería de Iconos Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* Ajustes para móviles */
        input, textarea, button, select, a { -webkit-tap-highlight-color: transparent; }
        body { touch-action: manipulation; }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-slate-900 text-slate-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        // ==========================================
        // 1. CONFIGURACIÓN DE FIREBASE (TUS DATOS REALES)
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyC7Q5umjaggIFFCfVGF_voUFkOyGn4GOvw",
            authDomain: "meserospb-ea0f8.firebaseapp.com",
            projectId: "meserospb-ea0f8",
            storageBucket: "meserospb-ea0f8.firebasestorage.app",
            messagingSenderId: "602960463994",
            appId: "1:602960463994:web:069fe52c5a84c0a11b53c3"
        };
        
        const APP_ID = "bar-sanchez-prod-v1";
        // ==========================================

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { 
            getFirestore, collection, addDoc, updateDoc, doc, onSnapshot, serverTimestamp, setDoc 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { 
            getAuth, signInAnonymously, onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const { useState, useEffect, useRef } = React;

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- HELPER PARA ICONOS (SOLUCIÓN SEGURA) ---
        const LucideIcon = ({ name, size = 24, className = "" }) => {
            const [svgHtml, setSvgHtml] = useState(null);

            useEffect(() => {
                const pascalName = name.replace(/(^\w|-\w)/g, (clear) => clear.replace('-', '').toUpperCase());
                if (window.lucide && window.lucide.icons && window.lucide.icons[pascalName]) {
                    const iconDef = window.lucide.icons[pascalName];
                    if (typeof window.lucide.createElement === 'function') {
                        const svgElement = window.lucide.createElement(iconDef);
                        svgElement.setAttribute('width', size);
                        svgElement.setAttribute('height', size);
                        if (className) svgElement.setAttribute('class', className);
                        setSvgHtml(svgElement.outerHTML);
                    }
                }
            }, [name, size, className]);

            if (!svgHtml) return <span className="inline-block w-6 h-6"></span>;
            return <span dangerouslySetInnerHTML={{ __html: svgHtml }} style={{ display: 'inline-flex', alignItems: 'center', justifyContent: 'center' }} />;
        };

        // Iconos
        const Bell = (p) => <LucideIcon name="bell" {...p} />;
        const CheckCircle = (p) => <LucideIcon name="check-circle" {...p} />;
        const QrCode = (p) => <LucideIcon name="qr-code" {...p} />;
        const AlertCircle = (p) => <LucideIcon name="alert-circle" {...p} />;
        const VolumeX = (p) => <LucideIcon name="volume-x" {...p} />;
        const LogOut = (p) => <LucideIcon name="log-out" {...p} />;
        const Beer = (p) => <LucideIcon name="beer" {...p} />;
        const Send = (p) => <LucideIcon name="send" {...p} />;
        const Clock = (p) => <LucideIcon name="clock" {...p} />;
        const Edit2 = (p) => <LucideIcon name="edit-2" {...p} />;
        const MapPin = (p) => <LucideIcon name="map-pin" {...p} />;
        const PlayCircle = (p) => <LucideIcon name="play-circle" {...p} />;
        const Power = (p) => <LucideIcon name="power" {...p} />;
        const Moon = (p) => <LucideIcon name="moon" {...p} />;
        const Lock = (p) => <LucideIcon name="lock" {...p} />;
        const WifiOff = (p) => <LucideIcon name="wifi-off" {...p} />;

        // --- COMPONENTE LOGO ---
        const BarLogo = ({ className = "", size = "h-16" }) => (
            <div className={`flex items-center justify-center ${className}`}>
                <img 
                src="https://i.imgur.com/crEnZHt.png" 
                alt="Bar Sanchez" 
                className={`${size} w-auto rounded-lg shadow-lg border-2 border-slate-800`}
                onError={(e) => { e.currentTarget.src = 'https://placehold.co/100x100/e2e8f0/1e293b?text=BAR'; }}
                />
            </div>
        );

        // --- MOTOR DE AUDIO ---
        const audioCtxRef = { current: null };
        const oscillatorRef = { current: null };
        const intervalRef = { current: null };

        const startPersistentAlarm = () => {
            if (navigator.vibrate) navigator.vibrate([500, 200, 500, 200, 500, 1000]);
            
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!audioCtxRef.current) audioCtxRef.current = new AudioContext();
            const ctx = audioCtxRef.current;
            if (ctx.state === 'suspended') ctx.resume();
            
            if (oscillatorRef.current) return;

            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();
            oscillator.type = 'sawtooth';
            oscillator.frequency.setValueAtTime(800, ctx.currentTime);
            oscillator.frequency.linearRampToValueAtTime(1200, ctx.currentTime + 0.5);
            oscillator.frequency.linearRampToValueAtTime(800, ctx.currentTime + 1.0);
            gainNode.gain.setValueAtTime(0.5, ctx.currentTime);

            oscillator.connect(gainNode);
            gainNode.connect(ctx.destination);
            oscillator.start();

            intervalRef.current = setInterval(() => {
                if (!oscillatorRef.current) return;
                const now = ctx.currentTime;
                oscillator.frequency.setValueAtTime(800, now);
                oscillator.frequency.linearRampToValueAtTime(1200, now + 0.5);
                oscillator.frequency.linearRampToValueAtTime(800, now + 1.0);
                if (navigator.vibrate) navigator.vibrate([500, 200]);
            }, 1000);
            oscillatorRef.current = oscillator;
        };

        const stopPersistentAlarm = () => {
            if (navigator.vibrate) navigator.vibrate(0);
            if (intervalRef.current) { clearInterval(intervalRef.current); intervalRef.current = null; }
            if (oscillatorRef.current) {
                try { oscillatorRef.current.stop(); oscillatorRef.current.disconnect(); } catch(e){}
                oscillatorRef.current = null;
            }
        };

        // --- APP PRINCIPAL ---
        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('landing');
            const [activeTableName, setActiveTableName] = useState(null);
            
            // ESTADOS
            const [requests, setRequests] = useState([]);
            const [isStoreOpen, setIsStoreOpen] = useState(true);
            const [isSystemActive, setIsSystemActive] = useState(false);
            const [loading, setLoading] = useState(true);
            const [permissionError, setPermissionError] = useState(false); 
            const [isDemoMode, setIsDemoMode] = useState(false); 

            // Estados Cliente
            const [cooldownSeconds, setCooldownSeconds] = useState(0);
            const [customOrderText, setCustomOrderText] = useState('');
            const [isSending, setIsSending] = useState(false);
            const [showCustomInput, setShowCustomInput] = useState(false);
            const [tempCustomName, setTempCustomName] = useState('');
            const cooldownIntervalRef = useRef(null);

            // 1. INICIALIZACIÓN INTELIGENTE (URL MÁGICAS)
            useEffect(() => {
                const init = async () => {
                    const params = new URLSearchParams(window.location.search);
                    const modeParam = params.get('mode');
                    const tableParam = params.get('table');

                    // Lógica de Enrutamiento
                    if (modeParam === 'admin') {
                        setView('admin');
                    } else if (tableParam) {
                        setView('customer');
                        setActiveTableName(tableParam);
                        localStorage.setItem('bar_app_table_name', tableParam);
                    } else {
                        // Si no hay params, revisamos memoria por si ya tenía mesa
                        const savedTable = localStorage.getItem('bar_app_table_name');
                        if (savedTable) {
                            setActiveTableName(savedTable);
                            // Opcional: Si queremos que vaya directo a cliente si ya tiene mesa:
                            // setView('customer'); 
                        }
                    }

                    try { await signInAnonymously(auth); } catch (e) { console.error("Error Auth:", e); }
                };
                init();
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            // 2. Data Listeners
            useEffect(() => {
                if (!user || isDemoMode) return;
                
                const requestsRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'service_requests');
                
                const unsubscribe = onSnapshot(requestsRef, 
                    (snapshot) => {
                        setPermissionError(false);
                        const loadedRequests = [];
                        snapshot.forEach((doc) => loadedRequests.push({ id: doc.id, ...doc.data() }));
                        loadedRequests.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                        setRequests(loadedRequests);
                    }, 
                    (error) => {
                        console.error("Firestore Error:", error);
                        if (error.code === 'permission-denied' || error.message.includes('insufficient permissions')) {
                            setPermissionError(true);
                        }
                    }
                );
                return () => unsubscribe();
            }, [user, isDemoMode]);

            // 3. Estado Bar
            useEffect(() => {
                if (!user || isDemoMode) return;
                const settingsRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'app_settings', 'global');
                
                const unsubscribe = onSnapshot(settingsRef, 
                    (docSnap) => {
                        if (docSnap.exists()) setIsStoreOpen(docSnap.data().isOpen);
                        else setDoc(settingsRef, { isOpen: true }).catch(()=>{});
                    },
                    (error) => {} // Silenciar error aquí, ya salta en el otro
                );
                return () => unsubscribe();
            }, [user, isDemoMode]);

            // 4. Control Alarma
            useEffect(() => {
                const pending = requests.filter(r => r.status === 'pending');
                if (pending.length > 0 && view === 'admin' && isSystemActive) startPersistentAlarm();
                else stopPersistentAlarm();
                return () => stopPersistentAlarm();
            }, [requests, view, isSystemActive]);

            useEffect(() => {
                return () => { if (cooldownIntervalRef.current) clearInterval(cooldownIntervalRef.current); };
            }, []);

            // --- ACCIONES ---
            
            const toggleStoreStatus = async () => {
                const newState = !isStoreOpen;
                if (confirm(newState ? "¿ABRIR el bar?" : "¿CERRAR el bar?")) {
                    if (isDemoMode) { setIsStoreOpen(newState); return; }
                    try {
                        await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'app_settings', 'global'), { isOpen: newState });
                    } catch(e) { alert("Error de permisos."); }
                }
            };

            const startCooldown = () => {
                setCooldownSeconds(30);
                if (cooldownIntervalRef.current) clearInterval(cooldownIntervalRef.current);
                cooldownIntervalRef.current = setInterval(() => {
                    setCooldownSeconds(prev => {
                        if (prev <= 1) { clearInterval(cooldownIntervalRef.current); return 0; }
                        return prev - 1;
                    });
                }, 1000);
            };

            const handleTableSelection = (tableName) => {
                setActiveTableName(tableName);
                localStorage.setItem('bar_app_table_name', tableName);
                setShowCustomInput(false);
            };

            const handleResetTable = () => {
                if (confirm('¿Cambiar de mesa?')) {
                    setActiveTableName(null);
                    localStorage.removeItem('bar_app_table_name');
                    setTempCustomName('');
                }
            };

            const handleCreateRequest = async (msg = null) => {
                if (cooldownSeconds > 0 || isSending || !activeTableName) return;
                setIsSending(true);

                if (isDemoMode) {
                    setTimeout(() => {
                        const newReq = { 
                            id: Math.random().toString(), 
                            tableId: activeTableName, 
                            status: 'pending', 
                            timestamp: { seconds: Date.now()/1000 }, 
                            message: msg 
                        };
                        setRequests(prev => [newReq, ...prev]);
                        if (navigator.vibrate) navigator.vibrate(50);
                        startCooldown();
                        setCustomOrderText('');
                        setIsSending(false);
                    }, 500);
                    return;
                }

                try {
                    await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'service_requests'), {
                        tableId: activeTableName,
                        status: 'pending',
                        timestamp: serverTimestamp(),
                        message: msg
                    });
                    if (navigator.vibrate) navigator.vibrate(50);
                    startCooldown();
                    setCustomOrderText('');
                } catch (e) {
                    console.error(e);
                    if (e.code === 'permission-denied') setPermissionError(true);
                    else alert("Error enviando pedido. Revisa tu conexión.");
                } finally {
                    setIsSending(false);
                }
            };

            const handleCompleteRequest = async (id) => {
                if (isDemoMode) {
                    setRequests(prev => prev.map(r => r.id === id ? { ...r, status: 'completed' } : r));
                    return;
                }
                try { await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'service_requests', id), { status: 'completed' }); } 
                catch(e) { console.error(e); }
            };

            const handleSimulateRequest = async () => {
                if (isDemoMode) {
                    const newReq = { id: Math.random().toString(), tableId: 'Mesa Prueba', status: 'pending', timestamp: { seconds: Date.now()/1000 }, message: 'Simulacro Demo' };
                    setRequests(prev => [newReq, ...prev]);
                    return;
                }
                try {
                    await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'service_requests'), {
                        tableId: 'Mesa Prueba', status: 'pending', timestamp: serverTimestamp(), message: 'Simulacro Admin'
                    });
                } catch(e) { if(e.code === 'permission-denied') setPermissionError(true); }
            };

            const activateSystem = () => {
                setIsSystemActive(true);
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                ctx.resume();
                audioCtxRef.current = ctx;
            };

            const getTableColorClass = (name) => {
                if (name.includes('Amarilla')) return 'bg-yellow-400 text-yellow-950 border-yellow-500';
                if (name.includes('Verde')) return 'bg-green-500 text-white border-green-600';
                if (name.includes('Azul')) return 'bg-blue-600 text-white border-blue-700';
                if (name.includes('Roja')) return 'bg-red-600 text-white border-red-700';
                return 'bg-slate-700 text-white border-slate-800';
            };

            // --- RENDERIZADO ---

            // PANTALLA DE ERROR DE PERMISOS (FALLBACK)
            if (permissionError && !isDemoMode) {
                return (
                    <div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center p-6 text-white text-center font-sans">
                        <Lock className="w-20 h-20 text-red-500 mb-6" />
                        <h1 className="text-3xl font-bold mb-2">Acceso Restringido</h1>
                        <p className="text-slate-300 mb-6 max-w-md">
                            La app se conecta a Firebase, pero las <strong>Reglas de Seguridad</strong> están bloqueando la entrada.
                        </p>
                        
                        <div className="bg-slate-800 p-4 rounded-lg w-full max-w-md text-left mb-6 border border-slate-700">
                            <p className="text-xs text-gray-400 uppercase font-bold mb-2">Solución en Firebase Console:</p>
                            <ol className="list-decimal list-inside text-sm space-y-2 text-gray-300">
                                <li>Ve a <strong>Firestore Database</strong> &gt; <strong>Reglas</strong></li>
                                <li>Borra todo y pega esto:</li>
                            </ol>
                            <div className="bg-black/50 p-2 mt-2 rounded text-xs font-mono text-green-400 overflow-x-auto whitespace-pre">
{`rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if true;
    }
  }
}`}
                            </div>
                        </div>

                        <div className="flex flex-col w-full max-w-sm gap-3">
                            <a href={`https://console.firebase.google.com/project/${firebaseConfig.projectId}/firestore/rules`} 
                               target="_blank"
                               className="bg-blue-600 hover:bg-blue-700 py-3 rounded-lg font-bold">
                                Ir a Consola Firebase
                            </a>
                            <div className="flex items-center gap-2 my-2 opacity-50"><div className="h-px bg-white flex-1"></div>O<div className="h-px bg-white flex-1"></div></div>
                            <button onClick={() => setIsDemoMode(true)} className="bg-green-700 hover:bg-green-600 py-3 rounded-lg font-bold flex items-center justify-center gap-2">
                                <WifiOff size={18}/> Usar Modo Demo (Offline)
                            </button>
                        </div>
                    </div>
                );
            }

            if (loading) return <div className="h-screen flex items-center justify-center bg-gray-100">Cargando...</div>;

            // Pantalla Despedida (Global)
            if (!isStoreOpen && view !== 'admin') {
                return (
                    <div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center p-8 text-white text-center font-sans fade-in">
                        <div className="mb-8 relative">
                            <div className="absolute inset-0 bg-blue-500 blur-3xl opacity-20 rounded-full"></div>
                            <BarLogo size="h-32" className="relative z-10" />
                        </div>
                        <h1 className="text-4xl font-black mb-4 tracking-tight">¡Gracias por tu visita!</h1>
                        <div className="w-16 h-1 bg-amber-500 mb-6 rounded-full"></div>
                        <p className="text-xl text-slate-300 mb-8 leading-relaxed">Nuestro turno ha finalizado.<br/>¡Te esperamos pronto!</p>
                        <div className="flex items-center gap-2 text-slate-500 text-sm mt-8 border-t border-slate-800 pt-4 px-8">
                            <Moon size={16} /> <span>Bar Sanchez</span>
                        </div>
                    </div>
                );
            }

            // Landing
            if (view === 'landing') {
                return (
                    <div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center p-6 text-white font-sans">
                        <div className="mb-8 text-center">
                            <BarLogo className="mb-4" />
                            <h1 className="text-3xl font-bold mb-2">Bar Sanchez</h1>
                            <p className="text-slate-400">Sistema de Atención {isDemoMode ? '(Demo Offline)' : ''}</p>
                        </div>
                        <div className="w-full max-w-md space-y-4">
                            <button onClick={() => setView('customer')} className="w-full bg-white text-slate-900 p-4 rounded-xl font-bold text-lg flex items-center justify-between hover:bg-gray-50 transition-colors shadow-lg">
                                <span>Soy Cliente</span> <QrCode className="text-blue-600" />
                            </button>
                            <button onClick={() => setView('admin')} className="w-full bg-slate-800 border border-slate-700 text-white p-4 rounded-xl font-bold text-lg flex items-center justify-between hover:bg-slate-700 transition-colors">
                                <span>Soy Administrador</span> <Beer className="text-amber-400"/>
                            </button>
                        </div>
                    </div>
                );
            }

            // Cliente
            if (view === 'customer') {
                if (!activeTableName) {
                    return (
                        <div className="min-h-screen bg-gray-100 p-6 flex flex-col font-sans">
                            <div className="text-center mb-8 mt-4">
                                <BarLogo className="mb-4" />
                                <h2 className="text-2xl font-bold text-gray-800">¿Dónde estás ubicado?</h2>
                            </div>
                            {!showCustomInput ? (
                                <div className="grid grid-cols-2 gap-4 max-w-md mx-auto w-full">
                                    {['Amarilla', 'Verde', 'Azul', 'Roja'].map((color) => (
                                        <button key={color} onClick={() => handleTableSelection(`Mesa ${color}`)} 
                                            className={`aspect-square rounded-2xl shadow-md flex flex-col items-center justify-center border-b-4 active:scale-95 transition-transform
                                            ${getTableColorClass(`Mesa ${color}`)}`}>
                                            <div className="bg-white/20 p-3 rounded-full mb-2"><MapPin /></div>
                                            <span className="font-bold text-lg">{color}</span>
                                        </button>
                                    ))}
                                    <button onClick={() => setShowCustomInput(true)} className="col-span-2 bg-white rounded-xl shadow-sm p-4 flex items-center justify-center gap-3 text-gray-600 border border-gray-200">
                                        <Edit2 size={20} /> <span className="font-medium">Otro</span>
                                    </button>
                                </div>
                            ) : (
                                <div className="max-w-md mx-auto w-full bg-white p-6 rounded-2xl shadow-lg">
                                    <h3 className="text-lg font-bold mb-4 text-gray-800">Nombre de ubicación</h3>
                                    <input type="text" placeholder="Ej: Barra..." className="w-full p-4 border border-gray-300 rounded-xl mb-4 text-lg outline-blue-500"
                                        value={tempCustomName} onChange={(e) => setTempCustomName(e.target.value)} autoFocus />
                                    <div className="flex gap-2">
                                        <button onClick={() => setShowCustomInput(false)} className="flex-1 py-3 text-gray-500 font-bold">Cancelar</button>
                                        <button onClick={() => { if(tempCustomName.trim()) handleTableSelection(tempCustomName.trim()); }} disabled={!tempCustomName.trim()} className="flex-1 bg-blue-600 text-white rounded-xl py-3 font-bold shadow-lg disabled:opacity-50">Confirmar</button>
                                    </div>
                                </div>
                            )}
                            <div className="mt-auto pt-8 text-center">
                                <button onClick={() => setView('landing')} className="text-gray-400 text-sm flex items-center justify-center gap-2 mx-auto"><LogOut size={16}/> Inicio</button>
                            </div>
                        </div>
                    );
                }

                const isWaiting = cooldownSeconds > 0;
                const isDisabled = isWaiting || isSending;

                return (
                    <div className="min-h-screen bg-gray-50 flex flex-col font-sans">
                        <header className="bg-white p-3 shadow-sm flex justify-between items-center sticky top-0 z-10">
                            <div className="flex items-center gap-3">
                                <BarLogo className="h-10" />
                                <div>
                                    <p className="text-[10px] text-gray-400 uppercase font-bold">Ubicación Actual</p>
                                    <div className={`text-sm px-2 py-0.5 rounded font-bold inline-block ${getTableColorClass(activeTableName)}`}>{activeTableName}</div>
                                </div>
                            </div>
                            <button onClick={handleResetTable} className="text-gray-400 hover:text-red-500 text-xs flex flex-col items-center"><Edit2 size={18}/><span>Cambiar</span></button>
                        </header>
                        <main className="flex-1 p-6 flex flex-col items-center justify-start text-center space-y-8 overflow-y-auto">
                            <div className="flex flex-col items-center w-full max-w-xs mt-4">
                                <button onClick={() => handleCreateRequest(null)} disabled={isDisabled}
                                    className={`w-64 h-64 rounded-full shadow-xl flex flex-col items-center justify-center text-white transition-all transform active:scale-95 duration-200
                                    ${isWaiting 
                                        ? 'bg-green-500 cursor-not-allowed shadow-none ring-4 ring-green-200' 
                                        : isSending
                                            ? 'bg-gray-400 cursor-wait'
                                            : 'bg-red-600 hover:bg-red-700 shadow-red-500/40 ring-4 ring-red-100'}`}>
                                    {isWaiting ? (
                                        <>
                                            <CheckCircle size={64} className="mb-4 animate-bounce" />
                                            <span className="text-xl font-bold px-4 leading-tight">¡Mesero en camino!</span>
                                            <div className="flex items-center gap-1 mt-4 text-green-100 font-mono bg-green-600/30 px-3 py-1 rounded-full"><Clock size={16} /><span>{cooldownSeconds}s</span></div>
                                        </>
                                    ) : (
                                        <>
                                            <Bell size={64} className="mb-4 animate-pulse" />
                                            <span className="text-2xl font-bold uppercase tracking-wider">Llamar<br/>Mesero</span>
                                        </>
                                    )}
                                </button>
                                {!isWaiting && <p className="mt-4 text-gray-400 text-sm animate-pulse">Toca para solicitar atención</p>}
                            </div>
                            <div className="w-full max-w-xs space-y-4 pb-8">
                                <button onClick={() => handleCreateRequest("Otra ronda, por favor")} disabled={isDisabled} className={`w-full py-4 px-6 rounded-xl font-bold text-lg flex items-center justify-center gap-3 transition-colors border-b-4 ${isDisabled ? 'bg-gray-200 text-gray-400 border-gray-300' : 'bg-amber-400 text-amber-950 border-amber-600 hover:bg-amber-500 active:bg-amber-600 active:border-t-4 active:border-b-0 shadow-lg'}`}>
                                    <Beer size={24} /> <span>¡Súbeme una ronda!</span>
                                </button>
                                <div className={`bg-white p-1 rounded-xl shadow-sm border transition-colors relative ${isDisabled ? 'border-gray-200 bg-gray-50' : 'border-gray-300 focus-within:border-blue-500'}`}>
                                    <textarea value={customOrderText} onChange={(e) => setCustomOrderText(e.target.value)} disabled={isDisabled} placeholder="Escribe un pedido especial aquí..." className="w-full resize-none outline-none text-gray-700 placeholder-gray-400 bg-transparent disabled:cursor-not-allowed p-3 text-sm" rows={2} />
                                    <div className="flex justify-end p-2">
                                        <button onClick={() => handleCreateRequest(customOrderText)} disabled={isDisabled || !customOrderText.trim()} className={`p-2 rounded-lg transition-colors flex items-center gap-2 text-sm font-bold ${isDisabled || !customOrderText.trim() ? 'text-gray-300 bg-gray-100 cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700 shadow-md px-4'}`}>Enviar <Send size={14} /></button>
                                    </div>
                                </div>
                            </div>
                        </main>
                    </div>
                );
            }

            // Admin
            if (view === 'admin') {
                const pendingRequests = requests.filter(r => r.status === 'pending');
                if (!isSystemActive) {
                    return (
                        <div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center p-8 text-white text-center font-sans">
                            {/* Logo grande en pantalla de espera */}
                            <BarLogo size="h-24" className="mb-6" />
                            <h2 className="text-2xl font-bold mb-4">Activar Alertas</h2>
                            <p className="text-slate-400 mb-8">Para recibir pedidos con sonido, toca el botón.</p>
                            <button onClick={activateSystem} className="w-full max-w-sm bg-blue-600 text-white font-bold py-4 px-8 rounded-full shadow-lg shadow-blue-600/50 animate-bounce">INICIAR TURNO</button>
                        </div>
                    );
                }
                return (
                    <div className={`min-h-screen transition-colors duration-300 ${pendingRequests.length > 0 ? 'bg-red-50' : 'bg-white'} font-sans flex flex-col`}>
                        <header className={`${pendingRequests.length > 0 ? 'bg-red-600' : 'bg-slate-900'} text-white p-4 shadow-md transition-colors duration-300`}>
                            <div className="flex justify-between items-center mb-2">
                                <div className="flex items-center gap-3">
                                    {/* LOGO EN EL HEADER DEL ADMIN (Rebota si hay pedidos) */}
                                    <BarLogo size="h-10" className={pendingRequests.length > 0 ? "animate-bounce" : ""} />
                                    <h1 className="font-bold text-lg">Panel Bar {isDemoMode ? '(Demo)' : ''}</h1>
                                </div>
                                <button onClick={() => setView('landing')} className="text-white/80 hover:text-white"><LogOut size={20}/></button>
                            </div>
                            <div className="flex justify-between items-end">
                                <div>
                                    <div className={`text-xs uppercase font-bold flex items-center gap-1 mb-1 ${isStoreOpen ? 'text-green-400' : 'text-red-400'}`}>
                                        <div className={`w-2 h-2 rounded-full ${isStoreOpen ? 'bg-green-400' : 'bg-red-400'}`}></div> {isStoreOpen ? 'BAR ABIERTO' : 'BAR CERRADO'}
                                    </div>
                                    <p className="font-bold">{pendingRequests.length > 0 ? `${pendingRequests.length} PEDIDOS` : "Todo tranquilo"}</p>
                                </div>
                                <button onClick={toggleStoreStatus} className={`text-xs font-bold px-3 py-2 rounded-lg border flex items-center gap-2 shadow-sm active:scale-95 transition-all ${isStoreOpen ? 'bg-red-900 border-red-700 text-white hover:bg-red-800' : 'bg-green-700 border-green-600 text-white hover:bg-green-600'}`}>
                                    <Power size={14} /> {isStoreOpen ? 'CERRAR TURNO' : 'ABRIR BAR'}
                                </button>
                            </div>
                        </header>
                        <main className="flex-1 p-4 overflow-y-auto">
                            {!isStoreOpen && (
                                <div className="bg-slate-800 text-slate-200 p-4 rounded-xl mb-4 text-center border border-slate-700 shadow-inner">
                                    <Moon className="mx-auto mb-2 text-slate-400" />
                                    <p className="font-bold">El bar está cerrado.</p>
                                </div>
                            )}
                            {pendingRequests.length === 0 ? (
                                <div className="h-full flex flex-col items-center justify-center text-gray-400 opacity-50 pb-20">
                                    <CheckCircle size={80} className="mb-4 text-gray-300" />
                                    <p className="text-lg font-medium">Sin pedidos pendientes.</p>
                                    <div className="mt-12 p-6 bg-gray-100 rounded-xl flex flex-col items-center border border-gray-200">
                                        <p className="text-xs uppercase font-bold text-gray-400 mb-2">Prueba de sonido</p>
                                        <button onClick={handleSimulateRequest} className="flex items-center gap-2 bg-white border border-gray-300 px-6 py-3 rounded-full shadow-sm text-gray-600 font-bold hover:bg-gray-50 active:scale-95 transition-all"><PlayCircle size={20} className="text-blue-500"/> Simular Pedido</button>
                                    </div>
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    <div className="bg-red-100 border-l-4 border-red-500 p-4 rounded text-red-800 flex items-start gap-3 mb-6 animate-pulse">
                                        <AlertCircle className="shrink-0 mt-1" /> <p className="font-bold">¡CLIENTE ESPERANDO!</p>
                                    </div>
                                    {pendingRequests.map((req) => (
                                        <div key={req.id} className="bg-white rounded-xl shadow-xl border-2 border-red-500 overflow-hidden">
                                            <div className="p-6">
                                                <div className="flex justify-between items-start mb-4">
                                                    <div>
                                                        <span className={`inline-block px-3 py-1 rounded-full font-bold text-sm mb-2 shadow-sm ${getTableColorClass(req.tableId)}`}>{req.tableId}</span>
                                                        <h2 className="text-2xl font-black text-gray-800">SOLICITUD</h2>
                                                    </div>
                                                    <span className="text-gray-400 text-xs font-mono">
                                                        {req.timestamp?.seconds 
                                                            ? new Date(req.timestamp.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                                                            : '...'}
                                                    </span>
                                                </div>
                                                {req.message && (
                                                    <div className="bg-amber-50 p-4 rounded-lg mb-4 border-l-4 border-amber-500">
                                                        <p className="text-xs text-amber-600 font-bold mb-1 uppercase tracking-wide">Pedido:</p>
                                                        <p className="text-amber-900 font-medium text-lg">"{req.message}"</p>
                                                    </div>
                                                )}
                                                <button onClick={() => handleCompleteRequest(req.id)} className="w-full bg-slate-900 text-white font-bold py-4 rounded-lg flex items-center justify-center gap-2 hover:bg-slate-800 active:bg-slate-950 transition-colors shadow-lg">
                                                    <VolumeX size={20} /> ATENDIDO / SILENCIAR
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </main>
                    </div>
                );
            }

            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>