<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bar Sanchez - Service Link [MEJORADO]</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        input, textarea, button, select, a { -webkit-tap-highlight-color: transparent; }
        body { touch-action: manipulation; overscroll-behavior-y: none; }
        .fade-in { animation: fadeIn 0.8s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes urgent-pulse { 0%, 100% { background-color: #ef4444; } 50% { background-color: #b91c1c; } }
        .urgent-bg { animation: urgent-pulse 1s infinite; }
    </style>
</head>
<body class="bg-slate-900">
    <div id="root"></div>
    <script type="text/babel" data-type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyC7Q5umjaggIFFCfVGF_voUFkOyGn4GOvw",
            authDomain: "meserospb-ea0f8.firebaseapp.com",
            projectId: "meserospb-ea0f8",
            storageBucket: "meserospb-ea0f8.firebasestorage.app",
            messagingSenderId: "602960463994",
            appId: "1:602960463994:web:069fe52c5a84c0a11b53c3"
        };
        const APP_ID = "bar-sanchez-prod-v1";

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, doc, onSnapshot, serverTimestamp, setDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const { useState, useEffect, useRef } = React;
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ============================================
        // MEJORA 1: SERVICE WORKER PARA NOTIFICACIONES
        // ============================================
        let swRegistration = null;
        const registerServiceWorker = async () => {
            if (!('serviceWorker' in navigator)) {
                console.log('Service Worker no soportado');
                return null;
            }
            try {
                const swCode = `
                    self.addEventListener('push', (e) => {
                        const data = e.data ? e.data.json() : {};
                        e.waitUntil(
                            self.registration.showNotification(data.title || 'üîî Bar Sanchez', {
                                body: data.body || 'Nueva solicitud',
                                icon: 'https://i.imgur.com/crEnZHt.png',
                                badge: 'https://i.imgur.com/crEnZHt.png',
                                tag: 'bar-pedido',
                                requireInteraction: true,
                                vibrate: [300, 100, 300, 100, 300],
                                silent: false,
                                renotify: true
                            })
                        );
                    });
                    self.addEventListener('notificationclick', (e) => {
                        e.notification.close();
                        e.waitUntil(clients.openWindow('/'));
                    });
                `;
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const reg = await navigator.serviceWorker.register(URL.createObjectURL(blob));
                console.log('‚úÖ Service Worker registrado');
                return reg;
            } catch (e) {
                console.error('Error SW:', e);
                return null;
            }
        };

        // ============================================
        // MEJORA 2: NOTIFICACIONES PERSISTENTES
        // ============================================
        const showPersistentNotification = async (title, body, tag) => {
            if (Notification.permission !== 'granted') return;
            
            if (navigator.vibrate) navigator.vibrate([400, 200, 400, 200, 400]);
            
            if (swRegistration) {
                try {
                    await swRegistration.showNotification(title, {
                        body: body,
                        icon: 'https://i.imgur.com/crEnZHt.png',
                        badge: 'https://i.imgur.com/crEnZHt.png',
                        tag: tag || 'bar-pedido',
                        requireInteraction: true,
                        vibrate: [400, 200, 400, 200, 400],
                        silent: false,
                        renotify: true,
                        timestamp: Date.now()
                    });
                    console.log('‚úÖ Notificaci√≥n enviada con SW');
                    return;
                } catch(e) { 
                    console.log('SW notification failed:', e); 
                }
            }
            
            const n = new Notification(title, {
                body: body,
                icon: 'https://i.imgur.com/crEnZHt.png',
                tag: tag,
                requireInteraction: true,
                vibrate: [400, 200, 400],
                silent: false
            });
            n.onclick = () => { window.focus(); n.close(); };
        };

        // Iconos simplificados
        const LucideIcon = ({ name, size = 24, className = "" }) => {
            const [svg, setSvg] = useState(null);
            useEffect(() => {
                const pName = name.replace(/(^\w|-\w)/g, (c) => c.replace('-', '').toUpperCase());
                if (window.lucide?.icons?.[pName] && window.lucide.createElement) {
                    const el = window.lucide.createElement(window.lucide.icons[pName]);
                    el.setAttribute('width', size);
                    el.setAttribute('height', size);
                    if (className) el.setAttribute('class', className);
                    setSvg(el.outerHTML);
                }
            }, [name, size, className]);
            return svg ? <span dangerouslySetInnerHTML={{ __html: svg }} style={{ display: 'inline-flex', alignItems: 'center' }} /> : <span className="w-6 h-6 inline-block"></span>;
        };

        const Bell = (p) => <LucideIcon name="bell" {...p} />;
        const CheckCircle = (p) => <LucideIcon name="check-circle" {...p} />;
        const VolumeX = (p) => <LucideIcon name="volume-x" {...p} />;
        const Power = (p) => <LucideIcon name="power" {...p} />;
        const Volume2 = (p) => <LucideIcon name="volume-2" {...p} />;
        const Vibrate = (p) => <LucideIcon name="vibrate" {...p} />;
        const Smartphone = (p) => <LucideIcon name="smartphone" {...p} />;
        const PauseCircle = (p) => <LucideIcon name="pause-circle" {...p} />;
        const Trash2 = (p) => <LucideIcon name="trash-2" {...p} />;
        const Sun = (p) => <LucideIcon name="sun" {...p} />;
        const MapPin = (p) => <LucideIcon name="map-pin" {...p} />;
        const Edit2 = (p) => <LucideIcon name="edit-2" {...p} />;
        const Clock = (p) => <LucideIcon name="clock" {...p} />;
        const Beer = (p) => <LucideIcon name="beer" {...p} />;
        const Send = (p) => <LucideIcon name="send" {...p} />;

        const BarLogo = ({ size = "h-16" }) => (
            <div className="flex items-center justify-center">
                <img src="https://i.imgur.com/crEnZHt.png" alt="Bar" className={`${size} w-auto rounded-lg shadow-lg border-2 border-slate-800`} />
            </div>
        );

        // Motor de audio simplificado
        const audioCtx = { current: null };
        const osc = { current: null };
        const intv = { current: null };
        const silent = { current: null };

        const startAlarm = (sound, muted) => {
            if (navigator.vibrate) navigator.vibrate([500, 200, 500]);
            if (sound && !muted) {
                const AC = window.AudioContext || window.webkitAudioContext;
                if (!audioCtx.current) audioCtx.current = new AC();
                const ctx = audioCtx.current;
                if (ctx.state === 'suspended') ctx.resume();
                if (!osc.current) {
                    const o = ctx.createOscillator();
                    const g = ctx.createGain();
                    o.type = 'sawtooth';
                    o.frequency.setValueAtTime(800, ctx.currentTime);
                    o.frequency.linearRampToValueAtTime(1200, ctx.currentTime + 0.5);
                    g.gain.setValueAtTime(0.5, ctx.currentTime);
                    o.connect(g);
                    g.connect(ctx.destination);
                    o.start();
                    osc.current = o;
                }
            } else {
                if (osc.current) { try { osc.current.stop(); osc.current.disconnect(); } catch(e){} osc.current = null; }
            }
            if (!intv.current) {
                intv.current = setInterval(() => {
                    if (osc.current && sound && !muted && audioCtx.current?.state === 'running') {
                        osc.current.frequency.setValueAtTime(800, audioCtx.current.currentTime);
                        osc.current.frequency.linearRampToValueAtTime(1200, audioCtx.current.currentTime + 0.5);
                    }
                    if (navigator.vibrate) navigator.vibrate([500, 200]);
                }, 1000);
            }
        };

        const stopAlarm = () => {
            if (navigator.vibrate) navigator.vibrate(0);
            if (intv.current) { clearInterval(intv.current); intv.current = null; }
            if (osc.current) { try { osc.current.stop(); osc.current.disconnect(); } catch(e){} osc.current = null; }
        };

        // APP SIMPLIFICADA
        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('customer'); // Cambiado a 'customer' por defecto
            const [activeTable, setActiveTable] = useState(null);
            const [requests, setRequests] = useState([]);
            const [sessions, setSessions] = useState([]); 
            const [isActive, setIsActive] = useState(false);
            const [loading, setLoading] = useState(true);
            const [sound, setSound] = useState(true); 
            const [muted, setMuted] = useState(false);
            const [notifPerm, setNotifPerm] = useState("default");
            const [swReady, setSwReady] = useState(false);
            const [cooldown, setCooldown] = useState(0);
            const [customText, setCustomText] = useState('');
            const [sending, setSending] = useState(false);
            const [showInput, setShowInput] = useState(false);
            const [tempName, setTempName] = useState('');
            const prevLen = useRef(0);
            const cdRef = useRef(null);

            useEffect(() => {
                const init = async () => {
                    const params = new URLSearchParams(window.location.search);
                    const mode = params.get('mode');
                    const table = params.get('table');
                    
                    if (mode === 'admin') {
                        setView('admin');
                        const reg = await registerServiceWorker();
                        if (reg) { 
                            swRegistration = reg; 
                            setSwReady(true);
                            console.log('‚úÖ SW listo');
                        }
                    } else if (table) {
                        setView('customer');
                        // Aqu√≠ ir√≠a la l√≥gica para seleccionar mesa desde URL
                    } else {
                        // Por defecto muestra la vista de cliente
                        setView('customer');
                        const saved = localStorage.getItem('bar_app_table_name');
                        if (saved) setActiveTable(saved);
                    }
                    
                    try { await signInAnonymously(auth); } catch (e) {}
                    if ("Notification" in window) setNotifPerm(Notification.permission);
                };
                init();
                const unsub = onAuthStateChanged(auth, (u) => { setUser(u); setLoading(false); });
                return unsub;
            }, []);

            // ============================================
            // MEJORA 3: DETECTOR DE NUEVOS PEDIDOS
            // ============================================
            useEffect(() => {
                if (!user || view !== 'admin') return;
                
                const reqRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'service_requests');
                const unsubReq = onSnapshot(reqRef, (snap) => {
                    const loaded = [];
                    snap.forEach((d) => loaded.push({ id: d.id, ...d.data() }));
                    loaded.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                    
                    const pending = loaded.filter(r => r.status === 'pending');
                    
                    // DETECCI√ìN: Nuevo pedido cuando aumenta la cantidad
                    if (pending.length > prevLen.current && isActive) {
                        setMuted(false);
                        const last = pending[0];
                        
                        console.log('üîî NUEVO PEDIDO DETECTADO:', last);
                        
                        // Notificaci√≥n persistente
                        showPersistentNotification(
                            `üö® PEDIDO: Mesa ${last.tableId}`,
                            last.message || 'Solicita atenci√≥n',
                            `pedido-${last.id}`
                        );

                        // MediaSession
                        if ("mediaSession" in navigator) {
                            navigator.mediaSession.metadata = new MediaMetadata({
                                title: `üîî Mesa ${last.tableId}`,
                                artist: last.message || 'Nuevo pedido',
                                album: "Bar Sanchez",
                                artwork: [{ src: "https://i.imgur.com/crEnZHt.png", sizes: "512x512", type: "image/png" }]
                            });
                            if (silent.current) silent.current.play().catch(()=>{});
                        }
                    }
                    
                    prevLen.current = pending.length;
                    setRequests(loaded);
                }, (err) => console.error('Firestore error:', err));

                const sessRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'active_sessions');
                const unsubSess = onSnapshot(sessRef, (snap) => {
                    const s = [];
                    snap.forEach((d) => s.push({ id: d.id, ...d.data() }));
                    setSessions(s);
                });

                return () => { unsubReq(); unsubSess(); };
            }, [user, view, isActive]);

            // Alarma cuando hay pendientes
            useEffect(() => {
                const pend = requests.filter(r => r.status === 'pending');
                if (pend.length > 0 && view === 'admin' && isActive) {
                    startAlarm(sound, muted);
                } else {
                    stopAlarm();
                }
                return stopAlarm;
            }, [requests, view, isActive, sound, muted]);

            const activate = async () => {
                setIsActive(true);
                
                // Audio context
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                ctx.resume();
                audioCtx.current = ctx;

                // Audio silencioso para MediaSession
                if (!silent.current) {
                    const s = new Audio("data:audio/wav;base64,UklGRjIAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAAABmYWN0BAAAAAAAAABkYXRhAAAAAA==");
                    s.loop = true;
                    s.volume = 0.01;
                    
                    if ("mediaSession" in navigator) {
                        navigator.mediaSession.metadata = new MediaMetadata({
                            title: "Sistema Activo",
                            artist: "Bar Sanchez",
                            artwork: [{ src: "https://i.imgur.com/crEnZHt.png", sizes: "512x512", type: "image/png" }]
                        });
                        navigator.mediaSession.setActionHandler('pause', () => { setMuted(true); s.pause(); });
                        navigator.mediaSession.setActionHandler('play', () => { setMuted(false); s.play(); });
                    }
                    s.play().catch(()=>{});
                    silent.current = s;
                }

                // Permisos
                if ("Notification" in window) {
                    const p = await Notification.requestPermission();
                    setNotifPerm(p);
                    console.log('Permiso notificaciones:', p);
                }
            };

            const completeReq = async (id) => {
                setMuted(false); 
                if (silent.current) silent.current.play().catch(()=>{});
                try { 
                    await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'service_requests', id), { 
                        status: 'completed' 
                    }); 
                } catch(e) {
                    console.error('Error completando:', e);
                }
            };

            const simulate = async () => {
                console.log('üß™ Simulando pedido...');
                await showPersistentNotification("üß™ PRUEBA", "Notificaci√≥n de prueba", "test");
                try {
                    await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'service_requests'), {
                        tableId: 'Mesa Prueba',
                        status: 'pending',
                        timestamp: serverTimestamp(),
                        message: 'Simulaci√≥n de prueba'
                    });
                } catch(e) {
                    console.error('Error simulando:', e);
                }
            };

            const closeTable = async (id) => {
                if(!confirm(`¬øLiberar ${id}?`)) return;
                try { 
                    await deleteDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'active_sessions', id)); 
                } catch(e) {
                    console.error('Error cerrando:', e);
                }
            };

            const getColor = (n) => {
                if (n.includes('Amarilla')) return 'bg-yellow-400 text-yellow-950';
                if (n.includes('Verde')) return 'bg-green-500 text-white';
                if (n.includes('Azul')) return 'bg-blue-600 text-white';
                if (n.includes('Roja')) return 'bg-red-600 text-white';
                return 'bg-slate-700 text-white';
            };

            const selectTable = async (name) => {
                setActiveTable(name);
                localStorage.setItem('bar_app_table_name', name);
                setShowInput(false);
                if (user) {
                    try {
                        await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'active_sessions', name), {
                            active: true, id: name, lastLogin: serverTimestamp()
                        });
                    } catch(e) {}
                }
            };

            const resetTable = () => {
                if (confirm('¬øCambiar de mesa?')) {
                    setActiveTable(null);
                    localStorage.removeItem('bar_app_table_name');
                    setTempName('');
                }
            };

            const createReq = async (msg = null) => {
                if (cooldown > 0 || sending || !activeTable) return;
                setSending(true);

                try {
                    await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'service_requests'), {
                        tableId: activeTable, status: 'pending', timestamp: serverTimestamp(), message: msg
                    });
                    if (navigator.vibrate) navigator.vibrate(50);
                    startCd();
                    setCustomText('');
                } catch (e) {
                    alert("Error enviando pedido.");
                } finally {
                    setSending(false);
                }
            };

            const startCd = () => {
                setCooldown(30);
                if (cdRef.current) clearInterval(cdRef.current);
                cdRef.current = setInterval(() => {
                    setCooldown(p => { if (p <= 1) { clearInterval(cdRef.current); return 0; } return p - 1; });
                }, 1000);
            };

            if (loading) return <div className="h-screen flex items-center justify-center text-white">Cargando...</div>;

            // VISTA CLIENTE
            if (view === 'customer') {
                if (!activeTable) {
                    return (
                        <div className="min-h-screen bg-gray-100 p-6 flex flex-col font-sans">
                            <div className="text-center mb-8 mt-4">
                                <BarLogo className="mb-4" />
                                <h2 className="text-2xl font-bold text-gray-800">¬øD√≥nde est√°s ubicado?</h2>
                            </div>
                            {!showInput ? (
                                <div className="grid grid-cols-2 gap-4 max-w-md mx-auto w-full">
                                    {['Amarilla', 'Verde', 'Azul', 'Roja'].map((color) => (
                                        <button 
                                            key={color} 
                                            onClick={() => selectTable(`Mesa ${color}`)}
                                            className={`aspect-square rounded-2xl shadow-md flex flex-col items-center justify-center border-b-4 active:scale-95 transition-transform ${getColor(`Mesa ${color}`)}`}
                                        >
                                            <div className="bg-white/20 p-3 rounded-full mb-2">
                                                <MapPin />
                                            </div>
                                            <span className="font-bold text-lg">{color}</span>
                                        </button>
                                    ))}
                                    <button 
                                        onClick={() => setShowInput(true)}
                                        className="col-span-2 bg-white rounded-xl shadow-sm p-4 flex items-center justify-center gap-3 text-gray-600 border border-gray-200"
                                    >
                                        <Edit2 size={20} /> <span className="font-medium">Otro</span>
                                    </button>
                                </div>
                            ) : (
                                <div className="max-w-md mx-auto w-full bg-white p-6 rounded-2xl shadow-lg">
                                    <input 
                                        type="text" 
                                        placeholder="Nombre de mesa..." 
                                        className="w-full p-4 border border-gray-300 rounded-xl mb-4 text-lg outline-blue-500" 
                                        value={tempName} 
                                        onChange={(e) => setTempName(e.target.value)} 
                                        autoFocus 
                                    />
                                    <div className="flex gap-2">
                                        <button 
                                            onClick={() => setShowInput(false)}
                                            className="flex-1 py-3 text-gray-500 font-bold"
                                        >
                                            Cancelar
                                        </button>
                                        <button 
                                            onClick={() => { if(tempName.trim()) selectTable(tempName.trim()); }}
                                            disabled={!tempName.trim()}
                                            className="flex-1 bg-blue-600 text-white rounded-xl py-3 font-bold shadow-lg disabled:opacity-50"
                                        >
                                            Confirmar
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    );
                }

                const isWaiting = cooldown > 0;
                return (
                    <div className="min-h-screen bg-gray-50 flex flex-col font-sans">
                        <header className="bg-white p-3 shadow-sm flex justify-between items-center sticky top-0 z-10">
                            <div className="flex items-center gap-3">
                                <BarLogo size="h-10" />
                                <div>
                                    <p className="text-[10px] text-gray-400 uppercase font-bold">Ubicaci√≥n</p>
                                    <div className={`text-sm px-2 py-0.5 rounded font-bold inline-block ${getColor(activeTable)}`}>
                                        {activeTable}
                                    </div>
                                </div>
                            </div>
                            <button 
                                onClick={resetTable}
                                className="text-gray-400 hover:text-red-500 text-xs flex flex-col items-center"
                            >
                                <Edit2 size={18}/><span>Cambiar</span>
                            </button>
                        </header>
                        <main className="flex-1 p-6 flex flex-col items-center justify-start text-center space-y-8 overflow-y-auto">
                            <div className="flex flex-col items-center w-full max-w-xs mt-4">
                                <button 
                                    onClick={() => createReq(null)}
                                    disabled={isWaiting || sending}
                                    className={`w-64 h-64 rounded-full shadow-xl flex flex-col items-center justify-center text-white transition-all transform active:scale-95 duration-200 ${
                                        isWaiting 
                                            ? 'bg-green-500 cursor-not-allowed shadow-none ring-4 ring-green-200' 
                                            : sending 
                                                ? 'bg-gray-400 cursor-wait' 
                                                : 'bg-red-600 hover:bg-red-700 shadow-red-500/40 ring-4 ring-red-100'
                                    }`}
                                >
                                    {isWaiting ? (
                                        <>
                                            <CheckCircle size={64} className="mb-4 animate-bounce" />
                                            <span className="text-xl font-bold px-4">¬°Avisado!</span>
                                            <div className="flex items-center gap-1 mt-4 text-green-100 font-mono bg-green-600/30 px-3 py-1 rounded-full">
                                                <Clock size={16} /><span>{cooldown}s</span>
                                            </div>
                                        </>
                                    ) : (
                                        <>
                                            <Bell size={64} className="mb-4 animate-pulse" />
                                            <span className="text-2xl font-bold uppercase tracking-wider">Llamar<br/>Mesero</span>
                                        </>
                                    )}
                                </button>
                            </div>
                            <div className="w-full max-w-xs space-y-4 pb-8">
                                <button 
                                    onClick={() => createReq("Otra ronda, por favor")}
                                    disabled={isWaiting || sending}
                                    className={`w-full py-4 px-6 rounded-xl font-bold text-lg flex items-center justify-center gap-3 transition-colors border-b-4 ${
                                        isWaiting || sending 
                                            ? 'bg-gray-200 text-gray-400 border-gray-300' 
                                            : 'bg-amber-400 text-amber-950 border-amber-600 hover:bg-amber-500 active:bg-amber-600 shadow-lg'
                                    }`}
                                >
                                    <Beer size={24} /> <span>¬°S√∫beme una ronda!</span>
                                </button>
                                <div className={`bg-white p-1 rounded-xl shadow-sm border transition-colors relative ${
                                    isWaiting || sending ? 'border-gray-200 bg-gray-50' : 'border-gray-300 focus-within:border-blue-500'
                                }`}>
                                    <textarea 
                                        value={customText} 
                                        onChange={(e) => setCustomText(e.target.value)}
                                        disabled={isWaiting || sending}
                                        placeholder="Escribe un pedido especial aqu√≠..." 
                                        className="w-full resize-none outline-none text-gray-700 placeholder-gray-400 bg-transparent disabled:cursor-not-allowed p-3 text-sm" 
                                        rows={2} 
                                    />
                                    <div className="flex justify-end p-2">
                                        <button 
                                            onClick={() => createReq(customText)}
                                            disabled={isWaiting || sending || !customText.trim()}
                                            className={`p-2 rounded-lg transition-colors flex items-center gap-2 text-sm font-bold ${
                                                isWaiting || sending || !customText.trim() 
                                                    ? 'text-gray-300 bg-gray-100 cursor-not-allowed' 
                                                    : 'bg-blue-600 text-white hover:bg-blue-700 shadow-md px-4'
                                            }`}
                                        >
                                            Enviar <Send size={14} />
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </main>
                    </div>
                );
            }

            if (loading) return <div className="h-screen flex items-center justify-center text-white">Cargando...</div>;

            if (view === 'admin') {
                const pending = requests.filter(r => r.status === 'pending');
                
                if (!isActive) {
                    return (
                        <div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center p-8 text-white text-center">
                            <BarLogo size="h-24" />
                            <h2 className="text-2xl font-bold my-4">Activar Sistema de Notificaciones</h2>
                            <p className="text-slate-400 mb-8 max-w-md">
                                Presiona para activar alertas de sonido, notificaciones push y controles desde pantalla de bloqueo.
                            </p>
                            <button 
                                onClick={activate} 
                                className="w-full max-w-sm bg-blue-600 font-bold py-4 px-8 rounded-full shadow-lg hover:bg-blue-700 active:scale-95 transition-transform"
                            >
                                üöÄ INICIAR TURNO
                            </button>
                            <div className="mt-8 text-sm text-slate-500 space-y-2">
                                <p>üîî Notificaciones: <span className={notifPerm === 'granted' ? 'text-green-400' : 'text-red-400'}>{notifPerm === 'granted' ? 'ACTIVAS ‚úÖ' : 'PENDIENTES ‚ö†Ô∏è'}</span></p>
                                <p>‚öôÔ∏è Service Worker: <span className={swReady ? 'text-green-400' : 'text-yellow-400'}>{swReady ? 'REGISTRADO ‚úÖ' : 'CARGANDO...'}</span></p>
                            </div>
                        </div>
                    );
                }

                return (
                    <div className={`min-h-screen ${pending.length > 0 ? 'urgent-bg' : 'bg-white'} font-sans flex flex-col transition-colors duration-300`}>
                        <header className={`${pending.length > 0 ? 'bg-red-600' : 'bg-slate-900'} text-white p-4 shadow-lg transition-colors duration-300`}>
                            <div className="flex justify-between items-center mb-3">
                                <div className="flex items-center gap-2">
                                    <BarLogo size="h-10" />
                                    <span className="font-bold text-lg">Panel Admin</span>
                                </div>
                                <div className="flex gap-2">
                                    {muted && (
                                        <span className="bg-yellow-500/20 text-yellow-300 text-xs px-2 py-1 rounded flex items-center gap-1">
                                            <PauseCircle size={12}/> Pausado
                                        </span>
                                    )}
                                    <button 
                                        onClick={() => setSound(!sound)} 
                                        className="bg-black/30 p-2 rounded-full hover:bg-black/50"
                                    >
                                        {sound ? <Volume2 size={20} /> : <Vibrate size={20} />}
                                    </button>
                                </div>
                            </div>
                            
                            <div className="flex gap-2 overflow-x-auto pb-2">
                                <div className="bg-black/30 text-xs px-3 py-2 rounded-lg flex items-center gap-2 whitespace-nowrap">
                                    <Bell size={14} /> {pending.length} Pedidos
                                </div>
                                <button 
                                    onClick={simulate}
                                    className="bg-purple-600 text-xs px-3 py-2 rounded-lg font-bold hover:bg-purple-700 whitespace-nowrap"
                                >
                                    üß™ Probar
                                </button>
                            </div>
                        </header>

                        <main className="flex-1 p-4 overflow-y-auto">
                            {/* Mesas conectadas */}
                            <div className="mb-6">
                                <h3 className="font-bold text-gray-600 text-sm uppercase mb-3 flex items-center gap-2">
                                    <Smartphone size={16}/> Mesas Activas ({sessions.length})
                                </h3>
                                {sessions.length === 0 ? (
                                    <div className="text-center py-4 bg-gray-50 rounded-lg text-gray-400 text-sm">
                                        Sin mesas conectadas
                                    </div>
                                ) : (
                                    <div className="grid grid-cols-2 gap-3">
                                        {sessions.map(s => (
                                            <div key={s.id} className="bg-white border p-3 rounded-lg flex justify-between items-center">
                                                <span className={`text-sm font-bold px-2 py-1 rounded ${getColor(s.id)}`}>
                                                    {s.id}
                                                </span>
                                                <button 
                                                    onClick={() => closeTable(s.id)}
                                                    className="text-gray-400 hover:text-red-500"
                                                >
                                                    <Trash2 size={16} />
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>

                            <hr className="my-6" />

                            {/* Pedidos pendientes */}
                            <h3 className="font-bold text-gray-600 text-sm uppercase mb-3 flex items-center gap-2">
                                <Bell size={16}/> Cola de Pedidos
                            </h3>

                            {pending.length === 0 ? (
                                <div className="text-center py-10">
                                    <CheckCircle size={60} className="mx-auto text-gray-300 mb-2" />
                                    <p className="text-gray-400 font-bold">Sin pedidos pendientes</p>
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    {pending.map((req) => (
                                        <div 
                                            key={req.id} 
                                            className="bg-white rounded-xl shadow-xl border-2 border-red-500 overflow-hidden"
                                        >
                                            <div className="p-6">
                                                <div className="flex justify-between items-start mb-4">
                                                    <span className={`px-3 py-1 rounded-full font-bold text-sm ${getColor(req.tableId)}`}>
                                                        {req.tableId}
                                                    </span>
                                                    <span className="text-gray-400 text-xs">
                                                        {req.timestamp?.seconds 
                                                            ? new Date(req.timestamp.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) 
                                                            : '...'}
                                                    </span>
                                                </div>
                                                
                                                {req.message && (
                                                    <div className="bg-amber-50 p-4 rounded-lg mb-4 border-l-4 border-amber-500">
                                                        <p className="text-amber-900 font-medium text-lg">
                                                            "{req.message}"
                                                        </p>
                                                    </div>
                                                )}
                                                
                                                <button 
                                                    onClick={() => completeReq(req.id)}
                                                    className="w-full bg-slate-900 text-white font-bold py-4 rounded-lg flex items-center justify-center gap-2 hover:bg-slate-800 active:bg-slate-950 shadow-lg"
                                                >
                                                    <VolumeX size={20} /> ATENDIDO
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </main>
                    </div>
                );
            }

            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>